# Single Sign On with Kubernetes
This lab created for my presentation in Open Infrastructure & Cloud Native Days Indonesia 2020. This will create a demo related to SSO with keycloak and Kubernetes. This is semi-automation lab, since there is a component that hard to automate.

Requirement:
- Digital Ocean account
You must have active digital ocean account.
- Domain for keycloak (your keycloak will be access publicly, you can use subdomain)
You must have domain for keycloak to access publicly.
- Public certificate for keycloak (you can use letsencrypt)
You can generate certificate using letsencrypt, get the `fullchain.pem` & `privkey.pem`

### Setup Infrastructure
- Populate `do_token` in `variables.tfvars` with the Digital Ocean token. you can create from the [official documentation](https://www.digitalocean.com/docs/apis-clis/api/create-personal-access-token/).
- Populate `do_ssh_key` with your public ssh key
- Populate keycloak management in `variables.tfvars` with your specific configuration
```
# Keycloak management
keycloak_domain = ""
keycloak_username = ""
keycloak_password = ""
```
- Setup infrastructure
```
terraform init
terraform apply -var-file="variables.tfvars"
```

### Setup Keycloak
keycloak will be running on docker-compose front with Envoy.
- Copy `fullchain.pem` & `privkey.pem` for your domain to `ansible/keycloak/roles/prepare/files/` directory.
- Create A record for your keycloak domain point to IP public generated by Digital Ocean & terraform
- Run ansible to deploy keycloak
```
cd ansible/keycloak/
ansible-playbook deploy.yaml -i hosts/hosts
```

### Keycloak Configuration

### Setup Kubernetes
Kubernetes configure using minikube with `none` provider. It will automatically configure the API server for OIDC with this following specification:
- oidc-username-prefix=oidc:
- oidc-groups-prefix=oidc:
- oidc-client-id=kubernetes
- oidc-username-claim=preferred_username
- oidc-groups-claim=user_groups
- oidc-issuer-url=https://{{ keycloak_domain }}/auth/realms/IAM

Run the ansible
```
cd ansible/kubernetes/
ansible-playbook deploy.yaml -i hosts/hosts
```

after you run the ansible, you will get OIDC kubeconfig in `/tmp/client-oidc.kubeconfig`. Use this kubeconfig to connect to your cluster/

### Setup OIDC Kubeconfig
- Install kubelogin
```
kubectl krew install oidc-login
```
- open and edit `/tmp/client-oidc.kubeconfig`
add this following configuration
```
contexts:
- context:
    cluster: sso-kubernetes
    user: oidc
  name: sso-kubernetes
current-context: sso-kubernetes
users:
- name: oidc
  user:
    exec:
      apiVersion: client.authentication.k8s.io/v1beta1
      args:
      - oidc-login
      - get-token
      - --oidc-issuer-url=https://{{ keycloak_domain }}/auth/realms/IAM
      - --oidc-client-id=kubernetes
      - --oidc-client-secret={{ keycloak_client_secret }}
      command: kubectl
      env: null
```
